<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parliamentary Scanner</title>
    <link rel="icon" type="image/svg+xml" href="/icon-no-bg (1).svg">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/parliscan-tokens.css">
    <link rel="stylesheet" href="/css/parliscan-components.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="ps-app">

    <!-- ===== Sidebar Navigation ===== -->
    <aside class="ps-sidebar">

        <!-- Logo block -->
        <div class="ps-sidebar__logo">
            <img src="/icon-no-bg (1).svg" class="ps-sidebar__logo-img" alt="ParliScan logo">
            <div class="ps-sidebar__logo-title">ParliScan</div>
        </div>

        <!-- Nav items — .tab-btn kept so existing switchTab() JS still works -->
        <nav class="ps-sidebar__nav">
            <button class="ps-sidebar__nav-item tab-btn active" data-tab="lookahead" onclick="switchTab('lookahead')" title="Calendar">
                <span class="ps-sidebar__nav-icon">▦</span>
                <span class="ps-sidebar__nav-label">Calendar</span>
            </button>
            <button class="ps-sidebar__nav-item tab-btn" data-tab="scanner" onclick="switchTab('scanner')" title="Scanner">
                <span class="ps-sidebar__nav-icon">⊙</span>
                <span class="ps-sidebar__nav-label">Scanner</span>
            </button>
            <button class="ps-sidebar__nav-item tab-btn" data-tab="record" onclick="switchTab('record')" title="Record">
                <span class="ps-sidebar__nav-icon">≡</span>
                <span class="ps-sidebar__nav-label">Record</span>
            </button>
            <button class="ps-sidebar__nav-item tab-btn" data-tab="alerts" onclick="switchTab('alerts')" title="Alerts">
                <span class="ps-sidebar__nav-icon">◉</span>
                <span class="ps-sidebar__nav-label">Alerts</span>
            </button>
        </nav>

        <!-- Sidebar collapse toggle -->
        <button class="ps-sidebar__toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">
            <span class="ps-sidebar__toggle-icon">‹</span>
        </button>

        <!-- Footer: API status (moved from scanner controls row) -->
        <div class="ps-sidebar__footer">
            <span id="apiStatus" class="api-status api-status--checking" title="Checking AI classifier connection...">
                <span class="api-status-dot"></span>
                <span class="api-status-label">Checking API...</span>
            </span>
        </div>

    </aside>

    <!-- ===== Main content area ===== -->
    <main class="ps-main">

        <!-- ===== Scanner Tab ===== -->
        <div id="tab-scanner" style="display:none;">
            <!-- Grouped Control Card -->
            <section class="control-group-card">
            <!-- Scan Controls -->
            <div id="controls">
                <div class="control-row">
                    <div class="date-picker-wrapper" id="datePickerWrapper">
                        <button class="date-picker-display placeholder" id="datePickerDisplay">Select date range</button>
                        <div class="calendar-dropdown" id="calendarDropdown"></div>
                        <input type="hidden" id="startDate">
                        <input type="hidden" id="endDate">
                    </div>
                    <button id="scanBtn" class="ps-btn ps-btn--primary">Scan</button>
                    <button id="cancelBtn" class="ps-btn ps-btn--ghost" style="display:none;">Cancel</button>
                </div>
            </div>

            <!-- Filter Bar: Sources + Topics -->
            <div class="ps-filter-bar">
                <div class="ps-chip-group" id="source-toggles">
                    <span class="ps-chip-group__label">SOURCES</span>
                    <div class="ps-chip-group__items">
                        <button class="ps-chip ps-chip--active" data-source="hansard" title="Records of debates in Commons and Lords">Hansard</button>
                        <button class="ps-chip ps-chip--active" data-source="written_questions" title="Questions tabled by MPs to government ministers">Written Qs</button>
                        <button class="ps-chip ps-chip--active" data-source="written_statements" title="Formal statements by ministers">Written Stmts</button>
                        <button class="ps-chip ps-chip--active" data-source="edms" title="Motions signed by MPs to show support for a cause">EDMs</button>
                        <button class="ps-chip ps-chip--active" data-source="bills" title="Proposed legislation being considered by Parliament">Bills</button>
                        <button class="ps-chip ps-chip--active" data-source="divisions" title="Recorded votes in the House of Commons">Divisions</button>
                    </div>
                </div>

                <div class="ps-chip-group">
                    <div class="ps-chip-group__header">
                        <span class="ps-chip-group__label">TOPICS</span>
                        <div style="display:flex;gap:4px;" onclick="event.stopPropagation()">
                            <button class="ps-btn ps-btn--ghost ps-btn--sm" onclick="toggleAllTopics(true)">All</button>
                            <button class="ps-btn ps-btn--ghost ps-btn--sm" onclick="toggleAllTopics(false)">None</button>
                        </div>
                    </div>
                    <div class="ps-chip-group__items" id="topicChipGroup"></div>
                </div>
            </div>

            <!-- Keywords / Topic Manager -->
            <div id="topic-manager">
                <div class="section-header" id="topicToggle" style="justify-content:flex-end;">
                    <div style="display:flex;align-items:center;gap:12px">
                        <button class="ps-btn ps-btn--ghost ps-btn--sm btn-undo disabled" id="undoBtn" onclick="event.stopPropagation(); undoLastAction()" title="Undo">&#8617;</button>
                        <span class="toggle-icon">&#9660;</span>
                    </div>
                </div>
                <div id="topicList" class="topic-container"></div>
                <div class="topic-add">
                    <input class="ps-input" type="text" id="newTopicName" placeholder="New topic name...">
                    <button id="addTopicBtn" class="ps-btn ps-btn--secondary ps-btn--sm">Add Topic</button>
                </div>
            </div>
            </section>

            <!-- Progress -->
            <section id="progress-section" style="display:none;">
                <div class="progress-header">
                    <div class="stage-indicator" id="stageIndicator">
                        <div class="stage" data-stage="1">
                            <div class="stage-circle">1</div>
                            <span class="stage-label">Keyword Search</span>
                        </div>
                        <div class="stage-line"></div>
                        <div class="stage" data-stage="2">
                            <div class="stage-circle">2</div>
                            <span class="stage-label">Classification</span>
                        </div>
                        <div class="stage-line"></div>
                        <div class="stage" data-stage="3">
                            <div class="stage-circle">3</div>
                            <span class="stage-label">Storing Results</span>
                        </div>
                    </div>
                    <button class="btn-minimize" id="minimizeBtn" style="display:none;" onclick="toggleProgressContent()" title="Minimize">&#9660;</button>
                </div>
                <div id="progressContent">
                    <p id="progressLabel">Preparing scan...</p>
                    <div id="progressPanels" style="display:none;">
                        <div id="keywordProgress" class="keyword-progress-panel"></div>
                        <div id="pipelineStats" class="pipeline-stats-row"></div>
                        <div id="sourceCirclesRow" class="source-circles-row" style="display:none;"></div>
                    </div>
                </div>
            </section>

            <!-- Scan History -->
            <section id="history-section">
                <h2>Scan History</h2>
                <div id="historyList"></div>
            </section>

            <!-- Results -->
            <section id="results-section">
                <div class="results-header">
                    <h2>Results</h2>
                    <button id="exportBtn" class="ps-btn ps-btn--ghost ps-btn--sm" title="Export to Excel" style="display:inline-flex;align-items:center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                </div>
                <div class="table-container ps-table-wrapper">
                    <table id="resultsTable" class="ps-table">
                        <thead>
                            <tr>
                                <th data-col="member_name">Name</th>
                                <th data-col="party">Party</th>
                                <th data-col="topics">Topic(s)</th>
                                <th data-col="summary">Summary</th>
                                <th data-col="forum">Forum</th>
                                <th data-col="verbatim_quote">Quote / Action</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Audit Panel -->
            <section id="audit-section">
                <div class="section-header" id="auditToggle">
                    <h2>Discarded Items</h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div id="auditSummary" class="audit-summary"></div>
                <div id="auditList" class="audit-container"></div>
            </section>
        </div>

        <!-- ===== Record Tab ===== -->
        <div id="tab-record" style="display:none;">
            <section id="record-section">
                <div class="results-header">
                    <h2>Master Stakeholder List</h2>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div class="ps-search ps-search--wide">
                            <input class="ps-search__input" type="text" id="masterSearchInput" placeholder="Search stakeholders…" oninput="filterMasterList()">
                        </div>
                        <button class="ps-btn ps-btn--ghost ps-btn--sm btn-undo disabled" id="masterUndoBtn" onclick="undoMasterDelete()" title="Undo delete" style="display:none;">&#8617;</button>
                        <button class="ps-btn ps-btn--ghost ps-btn--sm" title="Export to Excel" style="display:inline-flex;align-items:center;" onclick="window.location.href='/api/master/export'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="table-container ps-table-wrapper">
                    <table id="masterTable" class="ps-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Party</th>
                                <th>Type</th>
                                <th>Constituency</th>
                                <th>Topics</th>
                                <th>Priority</th>
                                <th>Notes</th>
                                <th>Activities</th>
                                <th>Latest</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="masterTableBody"></tbody>
                    </table>
                </div>
                <p id="masterEmpty" class="empty-state" style="display:none;">No stakeholders yet. Add members from scan results using the + button.</p>
            </section>
        </div>

        <!-- ===== Calendar Tab ===== -->
        <div id="tab-lookahead">

            <!-- Calendar header bar -->
            <div class="la-cal-header">
                <h2 class="la-cal-title">Calendar</h2>
                <div class="la-cal-sep"></div>
                <div class="la-cal-nav">
                    <button class="la-cal-nav-btn" id="laPrevWeek" title="Previous week">&#8592;</button>
                    <span class="la-cal-date-label" id="laDateLabel">This Week</span>
                    <button class="la-cal-nav-btn" id="laNextWeek" title="Next week">&#8594;</button>
                </div>
                <button class="la-cal-today-btn" id="laToday">Today</button>
                <div class="la-cal-spacer"></div>
                <!-- View toggle (segmented control) -->
                <div class="la-view-toggle">
                    <button class="la-view-btn active" data-view="week">Week</button>
                    <button class="la-view-btn" data-view="list">List</button>
                </div>
                <!-- Filter toggle -->
                <button class="la-filter-btn" id="laFilterBtn">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                    Filters
                </button>
                <!-- Refresh -->
                <button class="la-refresh-btn" id="laRefreshBtn" title="Refresh from Parliament">&#8635; Refresh</button>
            </div>

            <!-- Collapsible filter panel (rendered by JS) -->
            <div id="laFilterPanel" class="la-filter-panel" style="display:none;"></div>

            <!-- Info bar (rendered by JS) -->
            <div id="laInfoBar" class="la-info-bar"></div>

            <!-- Week view (time grid, rendered by JS) -->
            <div id="la-week-view" class="la-time-grid-outer"></div>

            <!-- List view (grouped rows, rendered by JS) -->
            <div id="la-list-view" class="la-list-outer" style="display:none;"></div>

        </div>

        <!-- ===== Alerts Tab ===== -->
        <div id="tab-alerts" style="display:none;">
            <!-- Alert List -->
            <section id="alertFormList" class="control-group-card">
                <div class="results-header" style="margin-bottom:12px;">
                    <h2>Email Alerts</h2>
                    <div style="display:flex;gap:8px;">
                        <button class="ps-btn ps-btn--secondary ps-btn--sm" onclick="showAlertForm('scan')">+ Scan Alert</button>
                        <button class="ps-btn ps-btn--secondary ps-btn--sm" onclick="showAlertForm('lookahead')">+ Calendar Alert</button>
                    </div>
                </div>
                <!-- Desktop table view -->
                <div class="table-container alerts-desktop ps-table-wrapper">
                    <table id="alertsTable" class="ps-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Schedule</th>
                                <th>Recipients</th>
                                <th>Last Run</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alertsListBody"></tbody>
                    </table>
                </div>
                <!-- Mobile card view -->
                <div class="alerts-mobile" id="alertsCardList"></div>
            </section>

            <!-- Alert Create/Edit Form (hidden by default) -->
            <section id="alertFormSection" class="control-group-card" style="display:none;">
                <div class="results-header" style="margin-bottom:16px;">
                    <h2 id="alertFormTitle">Create New Alert</h2>
                    <button class="ps-btn ps-btn--ghost ps-btn--sm" onclick="hideAlertForm()">Cancel</button>
                </div>

                <div class="alert-form-grid">
                    <!-- Left column: Basic config -->
                    <div>
                        <div style="margin-bottom:12px;">
                            <label class="source-label" style="margin-bottom:4px;">Alert Name</label>
                            <input class="ps-input" type="text" id="alertName" placeholder="e.g. Weekly AI Scan">
                        </div>

                        <div style="margin-bottom:12px;">
                            <label class="source-label" style="margin-bottom:4px;">Alert Type</label>
                            <select class="ps-select" id="alertType" onchange="_updateFormVisibility()">
                                <option value="scan">Scan (past activity)</option>
                                <option value="lookahead">Calendar (upcoming events)</option>
                            </select>
                        </div>

                        <div class="alert-schedule-row">
                            <div style="flex:1">
                                <label class="source-label" style="margin-bottom:4px;">Cadence</label>
                                <select class="ps-select" id="alertCadence" onchange="_updateFormVisibility()">
                                    <option value="weekly">Weekly</option>
                                    <option value="daily">Daily</option>
                                </select>
                            </div>
                            <div style="flex:1" id="alertDayOfWeekRow">
                                <label class="source-label" style="margin-bottom:4px;">Day</label>
                                <select class="ps-select" id="alertDayOfWeek">
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                    <option value="saturday">Saturday</option>
                                    <option value="sunday">Sunday</option>
                                </select>
                            </div>
                            <div style="flex:1">
                                <label class="source-label" style="margin-bottom:4px;">Time (UTC)</label>
                                <input class="ps-input" type="time" id="alertSendTime" value="09:00">
                            </div>
                        </div>

                        <div style="margin-bottom:12px;">
                            <label class="source-label" style="margin-bottom:4px;">Timezone</label>
                            <select class="ps-select" id="alertTimezone">
                                <option value="Europe/London">Europe/London (GMT/BST)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>

                        <div style="margin-bottom:12px;">
                            <label class="source-label" style="margin-bottom:4px;">Recipients (one per line or comma-separated)</label>
                            <textarea class="ps-textarea" id="alertRecipients" rows="3" placeholder="email@example.com"></textarea>
                        </div>
                    </div>

                    <!-- Right column: Type-specific config -->
                    <div>
                        <!-- Scan config -->
                        <div id="alertScanConfig">
                            <div style="margin-bottom:12px;">
                                <label class="source-label" style="margin-bottom:4px;">Scan Period (days back)</label>
                                <input class="ps-input" type="number" id="alertScanPeriod" value="7" min="1" max="90" style="width:100px;">
                            </div>

                            <div style="margin-bottom:12px;">
                                <label class="source-label" style="margin-bottom:6px;">Topics</label>
                                <div id="alertTopicCheckboxes"></div>
                            </div>

                            <div style="margin-bottom:12px;">
                                <label class="source-label" style="margin-bottom:6px;">Sources</label>
                                <div id="alertSourceCheckboxes"></div>
                            </div>
                        </div>

                        <!-- Lookahead config -->
                        <div id="alertLookaheadConfig" style="display:none;">
                            <div style="margin-bottom:12px;">
                                <label class="source-label" style="margin-bottom:4px;">Days Ahead</label>
                                <input class="ps-input" type="number" id="alertLookaheadDays" value="7" min="1" max="90" style="width:100px;">
                            </div>

                            <div style="margin-bottom:12px;">
                                <label class="source-label" style="margin-bottom:6px;">Event Types</label>
                                <div id="alertEventTypeCheckboxes"></div>
                            </div>

                            <div style="margin-bottom:12px;">
                                <label class="source-label" style="margin-bottom:6px;">Houses</label>
                                <div id="alertHouseCheckboxes"></div>
                            </div>

                            <div style="margin-bottom:12px;">
                                <label class="source-label" style="margin-bottom:6px;">Topics (for keyword filtering)</label>
                                <div id="alertLookaheadTopicCheckboxes"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-top:16px;">
                    <button class="ps-btn ps-btn--primary" onclick="saveAlert()">Save Alert</button>
                    <button class="ps-btn ps-btn--ghost ps-btn--sm" onclick="hideAlertForm()">Cancel</button>
                </div>
            </section>

            <!-- Alert Run History Panel (hidden by default) -->
            <section id="alertHistoryPanel" class="control-group-card" style="display:none;">
                <div class="results-header" style="margin-bottom:12px;">
                    <h2 id="alertHistoryTitle">Run History</h2>
                    <button class="ps-btn ps-btn--ghost ps-btn--sm" onclick="hideAlertHistory()">Close</button>
                </div>
                <div class="table-container ps-table-wrapper">
                    <table id="alertHistoryTable" class="ps-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Recipients</th>
                                <th>Results</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody id="alertHistoryBody"></tbody>
                    </table>
                </div>
            </section>
        </div>

    </main>

    <script src="/js/app.js"></script>
    <script src="/js/datepicker.js"></script>
    <script src="/js/topics.js"></script>
    <script src="/js/scanner.js"></script>
    <script src="/js/results.js"></script>
    <script src="/js/master.js"></script>
    <script src="/js/lookahead.js"></script>
    <script src="/js/alerts.js"></script>
</body>
</html>
